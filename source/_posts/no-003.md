---
title: JavaScriptäº‹ä»¶å¾ªç¯ã€å¾®ä»»åŠ¡ä¸MutationObserverå…¨é¢è§£æ
date: 2023-10-12 02:30:21
layout: 'archives'
urlname: notes
keywords: 'JavaScript'
tags:
- JavaScript
categories: 
- ç¬”è®°
---



---

# JavaScriptäº‹ä»¶å¾ªç¯ã€å¾®ä»»åŠ¡ä¸MutationObserverå…¨é¢è§£æ

## 1ï¸âƒ£ äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰æ ¸å¿ƒæœºåˆ¶
äº‹ä»¶å¾ªç¯æ˜¯æµè§ˆå™¨åè°ƒä»»åŠ¡æ‰§è¡Œçš„æ ¸å¿ƒæœºåˆ¶ï¼Œç”¨äºè°ƒåº¦äº‹ä»¶ã€ç”¨æˆ·äº¤äº’ã€è„šæœ¬æ‰§è¡Œå’Œæ¸²æŸ“ã€‚å…¶è¿è¡Œæµç¨‹åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š
1. **ä»»åŠ¡é˜Ÿåˆ—ï¼ˆTask Queueï¼‰**  
   ä»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­é€‰å–**ä¸€ä¸ª**å¯æ‰§è¡Œä»»åŠ¡ï¼ˆå¦‚`setTimeout`ã€`I/O`æ“ä½œï¼‰ï¼Œæ‰§è¡Œå®Œæ¯•åè¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚
2. **å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆMicrotask Queueï¼‰**  
   æ‰§è¡Œ**æ‰€æœ‰**å¾®ä»»åŠ¡ï¼ˆå¦‚`Promise.then()`ã€`MutationObserver`ï¼‰ï¼Œç›´åˆ°é˜Ÿåˆ—æ¸…ç©ºã€‚æ­¤é˜¶æ®µä¼šé˜»å¡æ¸²æŸ“ã€‚
3. **æ¸²æŸ“æ›´æ–°ï¼ˆRenderingï¼‰**  
   æ ¹æ®æµè§ˆå™¨åˆ·æ–°ç‡ï¼ˆé€šå¸¸60Hzï¼Œé—´éš”16.67msï¼‰å†³å®šæ˜¯å¦æ›´æ–°UIã€‚éæ¯æ¬¡å¾ªç¯å¿…è§¦å‘ã€‚

> ğŸ’¡ **å…³é”®ç‰¹æ€§**ï¼šå¾®ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œä¼˜å…ˆçº§é«˜äºå®ä»»åŠ¡ï¼Œä¸”åœ¨**åŒä¸€äº‹ä»¶å¾ªç¯ä¸­è¿ç»­æ‰§è¡Œ**ç›´è‡³æ¸…ç©ºã€‚

---

## 2ï¸âƒ£ å®ä»»åŠ¡ï¼ˆMacrotaskï¼‰ä¸å¾®ä»»åŠ¡ï¼ˆMicrotaskï¼‰å¯¹æ¯”
| **ç±»å‹** | **å¸¸è§API** | **æ‰§è¡Œæ—¶æœº** | **é˜Ÿåˆ—ç‰¹æ€§** |
|----------|-------------|--------------|--------------|
| **å®ä»»åŠ¡** | `setTimeout`, `setInterval`, `I/O`, UIæ¸²æŸ“ | æ¯æ¬¡å¾ªç¯æ‰§è¡Œä¸€ä¸ª | å¤šé˜Ÿåˆ—ï¼ˆæŒ‰ä»»åŠ¡æºåˆ†ç»„ï¼‰ |
| **å¾®ä»»åŠ¡** | `Promise.then()`, `queueMicrotask()`, `MutationObserver` | å®ä»»åŠ¡ç»“æŸåç«‹å³æ‰§è¡Œæ‰€æœ‰ | å•é˜Ÿåˆ—ï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰ |

**æ‰§è¡Œé¡ºåºç¤ºä¾‹**ï¼š
```javascript
setTimeout(() => console.log('å®ä»»åŠ¡'), 0);
Promise.resolve().then(() => console.log('å¾®ä»»åŠ¡'));
// è¾“å‡ºï¼šå¾®ä»»åŠ¡ â†’ å®ä»»åŠ¡
```

---

## 3ï¸âƒ£ MutationObserverçš„å·¥ä½œåŸç†ä¸åº”ç”¨
### 3.1 æ ¸å¿ƒæœºåˆ¶
- **å¼‚æ­¥ç›‘å¬DOMå˜åŒ–**ï¼Œå›è°ƒå‡½æ•°å±äº**å¾®ä»»åŠ¡**ï¼Œåœ¨DOMä¿®æ”¹åã€æ¸²æŸ“å‰æ‰§è¡Œã€‚
- **æ‰¹é‡å¤„ç†**ï¼šè¿ç»­DOMå˜æ›´åˆå¹¶ä¸ºä¸€æ¬¡å›è°ƒï¼Œé€šè¿‡`MutationRecord`æ•°ç»„ä¼ é€’å˜æ›´è¯¦æƒ…ã€‚

### 3.2 ä½¿ç”¨æ­¥éª¤
```javascript
// 1. åˆ›å»ºè§‚å¯Ÿå™¨
const observer = new MutationObserver((mutations) => {
  mutations.forEach(m => console.log('DOMå·²å˜æ›´', m.type));
});

// 2. é…ç½®è§‚å¯Ÿé€‰é¡¹
const config = {
  attributes: true,    // ç›‘å¬å±æ€§å˜åŒ–
  childList: true,    // ç›‘å¬å­èŠ‚ç‚¹å˜åŒ–
  subtree: true       // ç›‘å¬æ‰€æœ‰åä»£èŠ‚ç‚¹
};

// 3. å¯åŠ¨è§‚å¯Ÿ
observer.observe(document.body, config);

// 4. è§¦å‘å˜æ›´ï¼ˆéœ€æ‰‹åŠ¨ä¿®æ”¹DOMå±æ€§ï¼‰
document.body.setAttribute('data-test', Date.now()); // âœ… å¿…é¡»ä¸»åŠ¨è§¦å‘å˜æ›´

// 5. åœæ­¢è§‚å¯Ÿ
// observer.disconnect();
```

### 3.3 å¸¸è§é—®é¢˜
- **å›è°ƒæœªè§¦å‘**ï¼šæœªå®é™…ä¿®æ”¹DOMå±æ€§ï¼ˆå¦‚ä»…æ³¨å†Œè§‚å¯Ÿä½†æœªè°ƒç”¨`setAttribute`ï¼‰ã€‚
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé€šè¿‡`attributeFilter`é™å®šç›‘å¬å±æ€§ï¼ˆå¦‚`['class', 'style']`ï¼‰ã€‚

---

## 4ï¸âƒ£ å®é™…å¼€å‘æ³¨æ„äº‹é¡¹
1. **å¾®ä»»åŠ¡é€’å½’é£é™©**  
   å¾®ä»»åŠ¡ä¸­é€’å½’æ·»åŠ å¾®ä»»åŠ¡ä¼šå¯¼è‡´**é˜»å¡æ¸²æŸ“**ï¼ˆä¾‹ï¼š`queueMicrotask`å†…é€’å½’è°ƒç”¨è‡ªèº«ï¼‰ã€‚
   ```javascript
   function recursiveMicrotask() {
     queueMicrotask(() => {
       // é•¿æ—¶é—´æ“ä½œå°†å†»ç»“UI
       recursiveMicrotask(); 
     });
   }
   ```
2. **è·¨æµè§ˆå™¨å…¼å®¹æ–¹æ¡ˆ**  
   è€æ—§æµè§ˆå™¨éœ€é™çº§å¤„ç†ï¼š
   ```javascript
   function runMicrotask(func) {
     if (typeof Promise !== 'undefined') {
       Promise.resolve().then(func);
     } else if (typeof MutationObserver !== 'undefined') {
       const obs = new MutationObserver(func);
       obs.observe(document.body, { attributes: true });
       document.body.setAttribute('microtask-trigger', Date.now()); // å¿…é¡»è§¦å‘å˜æ›´
     } else {
       setTimeout(func, 0);
     }
   }
   ```
3. **Node.jså·®å¼‚**  
   `process.nextTick`ä¼˜å…ˆçº§é«˜äº`Promise`ï¼Œå±äºç‹¬ç«‹é˜Ÿåˆ—ã€‚

---

## 5ï¸âƒ£ æ€»ç»“ä¸æœ€ä½³å®è·µ
- **ä¼˜å…ˆä½¿ç”¨** `queueMicrotask` æ›¿ä»£ `Promise.resolve().then()`ï¼Œé¿å…åˆ›å»ºå†—ä½™Promiseå®ä¾‹ã€‚
- **æ…ç”¨å¾®ä»»åŠ¡é€’å½’**ï¼šé¿å…é•¿æ—¶é—´é˜»å¡ä¸»çº¿ç¨‹ï¼Œå¤æ‚ä»»åŠ¡æ‹†åˆ†ä¸ºå®ä»»åŠ¡ã€‚
- **MutationObserveré€‚ç”¨åœºæ™¯**ï¼š
  - ç›‘å¬ç‰¹å®šå…ƒç´ å±æ€§å˜æ›´ï¼ˆå¦‚è¡¨å•åŠ¨æ€éªŒè¯ï¼‰
  - å®ç°é˜²ç¯¡æ”¹æ°´å°ï¼ˆDOMåˆ é™¤åè‡ªåŠ¨é‡å»ºï¼‰
  - æ›¿ä»£å·²åºŸå¼ƒçš„`Object.observe`

> âš ï¸ **æ€§èƒ½è­¦ç¤º**ï¼šå¾®ä»»åŠ¡é˜Ÿåˆ—æ¸…ç©ºå‰ä¼šé˜»å¡æ¸²æŸ“ï¼Œå•ä¸ªä»»åŠ¡è€—æ—¶éœ€æ§åˆ¶åœ¨ **1ms** ä»¥å†…ä»¥ç»´æŒ60fpsæµç•…åº¦

---  
**å‚è€ƒèµ„æ–™**ï¼š  
1. [æµè§ˆå™¨äº‹ä»¶å¾ªç¯æœºåˆ¶](http://mp.weixin.qq.com/s?__biz=MzU3NTg5MjU1Mw==)  
2. [å¾®ä»»åŠ¡æ‰§è¡ŒåŸç†](https://wenku.csdn.net/doc/60r6axocqh)  
3. [å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡è¯¦è§£](http://mp.weixin.qq.com/s?__biz=MjM5MDA2MTI1MA==)  
6. [MutationObserverå®æˆ˜](https://blog.csdn.net/weixin_42369598/article/details/122918748)